#!/usr/bin/env bash

set -euo pipefail

SESSION_NAME="tde"
LAUNCH_CMDS=()

print_help() {
    cat <<'EOF'
NAME
    tde - open project workspaces

SYNOPSIS
    New Session Mode: Create 'tde' tmux session and add project workspace windows from the $HOME/.tde
    configuration file:

        tde [OPTION...]

    Current Session Mode: Add project workspace windows to the current tmux session:

        tde [OPTION...] PROJECT_DIR...

OPTIONS
    --dry-run, -n
        print tmux commands without doing anything.

    --help, -h
        print this text.

    -l, --launch [PANE:]COMMAND
        Execute shell COMMAND in pane PANE of each project workspace window. PANE must be between 1 and
        the value specified by the --panes option. PANE defaults to 1.

    -p,--panes=PANES
        Open window with PANES panes. PANES is 1..9. Pane 1 is positioned on the left hand side of the
        enclosing window; panes 2..PANES are arranged vertically on the right hand side. This option
        value defaults 1.

DESCRIPTION
    `tde` is a bash script which opens project directory workspaces in separate tmux windows. The
    script has two modes of operation:

    New Session Mode:

        If no project directories are specified on the command-line a tmux session named `tde` is
        created and project workspace windows are added from the list of directories read from the
        `$HOME/.tde` configuration file.

    Current Session Mode: 

        If project directories are specified on the command-line then project workspace windows are
        added to current tmux session.

    The optional $HOME/.tde configuration file contains a list of project directories, one per line. Blank
    lines and lines beginning with a # character are skipped.

    For each project directory:

    1. A new window name is generated from the project directory's base name minus its file name extension
       and with remaining period characters replaced with hyphens.
    2. If a tmux window with the same name already exists in the target session then print a warning and
       skip to the next project directory.
    3. A new tmux window is created with the newly generated window name and the window start directory
       set to the project directory.
    4. If PANES is greater than 1 then pane 1 is split vertically creating a second pane.
    5. If PANES is greater than 2 then panes 3..PANES are created by splitting pane 2 horizontally
       PANES - 2 times.
    6. The left-hand pane (pane 1) is selected.

    Finally the first newly created project window is selected and if `tde` was executed in New Session
    Mode the `tde` session is attached.
EOF
}

# Print or execute tmux commands
tmux_cmd() {
    if [[ -n "$DRY_RUN" || -n "$TEST_TDE" ]]; then
        echo "tmux $*"
    else
        tmux "$@"
    fi
}

# Generate window name from directory
window_name() {
    local dir="$1"
    echo "$(basename "$dir")"
}

# Get a list of existing window names in a session
existing_windows() {
    if [[ -n "$TEST_TDE" ]]; then
        echo ""
    else
        local session="$1"
        tmux list-windows -t "$session" -F '#W' 2>/dev/null || true
    fi
}

# Get window index by window name in a session
window_index_by_name() {
    if [[ -n "$DRY_RUN" || -n "$TEST_TDE" ]]; then
        echo "999"
    else
        local session="$1"
        local win_name="$2"
        tmux list-windows -t "$session" -F '#I:#W' | awk -F: -v name="$win_name" '$2 == name {print $1}'
    fi
}

# Validate launch commands
validate_launch_commands() {
    for LAUNCH_CMD_SPEC in "${LAUNCH_CMDS[@]}"; do
        local pane_num
        local command

        if [[ "$LAUNCH_CMD_SPEC" == *:* ]]; then
            pane_num="${LAUNCH_CMD_SPEC%%:*}"
            command="${LAUNCH_CMD_SPEC#*:}"
        else
            pane_num="1" # Default to pane 1
            command="$LAUNCH_CMD_SPEC"
        fi

        if ! [[ "$pane_num" =~ ^[1-9]$ ]] || (( pane_num < 1 || pane_num > PANES )); then
            echo "Error: Invalid pane number '$pane_num' for --launch option. Must be between 1 and $PANES." >&2
            exit 1
        fi

        # TODO: drop old code
        # if ! command -v "$command" &> /dev/null; then
        #     echo "Error: Launch command '$command' not found or not executable." >&2
        #     exit 1
        # fi
    done
}

# Execute launch commands in specified panes
execute_launch_commands() {

    local session_name="$1"
    local win_index="$2"
    local dir="$3"

    if [[ ${#LAUNCH_CMDS[@]} -gt 0 ]]; then
        for LAUNCH_CMD_SPEC in "${LAUNCH_CMDS[@]}"; do
            local pane_num
            local command

            if [[ "$LAUNCH_CMD_SPEC" == *:* ]]; then
                pane_num="${LAUNCH_CMD_SPEC%%:*}"
                command="${LAUNCH_CMD_SPEC#*:}"
            else
                pane_num="1" # Default to pane 1
                command="$LAUNCH_CMD_SPEC"
            fi
            tmux_cmd send-keys -t "$session_name:$win_index.$pane_num" -l "$command"
            tmux_cmd send-keys -t "$session_name:$win_index.$pane_num" Enter
        done
    fi
}

# Parse options
DRY_RUN=                # Set by --dry-run option
TEST_TDE=${TEST_TDE:=}  # Set by test-tde.sh
PANES=1
PROJECT_DIRS=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        --dry-run|-n)
            DRY_RUN=true
            shift
            ;;
        -p|--panes)
            PANES="$2"
            if ! [[ "$PANES" =~ ^[1-9]$ ]]; then
                echo "Error: PANES must be between 1 and 9" >&2
                exit 1
            fi
            shift 2
            ;;
        --panes=*) 
            PANES="${1#*=}"
            if ! [[ "$PANES" =~ ^[1-9]$ ]]; then
                echo "Error: PANES must be between 1 and 9" >&2
                exit 1
            fi
            shift
            ;;
        -l|--launch)
            LAUNCH_CMDS+=("$2")
            shift 2
            ;;
        --help|-h)
            print_help
            exit 0
            ;;
        -*)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
        *)
            PROJECT_DIRS+=("$1")
            shift
            ;;
    esac
done


# Validate launch commands after all options are parsed
validate_launch_commands

INSIDE_TMUX=0
if [[ -n "${TMUX:-}" ]]; then
    INSIDE_TMUX=1
fi

# Mode detection and error handling
if [[ ${#PROJECT_DIRS[@]} -eq 0 ]]; then
    # New Session Mode
    if [[ $INSIDE_TMUX -eq 1 ]]; then
        echo "Error: No project directories specified; cannot run New Session Mode inside tmux." >&2
        exit 1
    fi
    if [[ -z "$TEST_TDE" ]]; then
        if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
              echo "Attaching to existing session '$SESSION_NAME'."
              tmux_cmd attach-session -t "$SESSION_NAME"
              exit
          fi
    fi
    # Read project directories from $HOME/.tde
    while IFS= read -r line; do
        [[ -z "$line" || "$line" =~ ^# ]] && continue
        expanded_line=$(eval echo "$line") # Expand ~ and $HOME
        PROJECT_DIRS+=("$expanded_line")
    done < "$HOME/.tde"
    if [[ ${#PROJECT_DIRS[@]} -eq 0 ]]; then
        echo "Error: No project directories found in $HOME/.tde" >&2
        exit 1
    fi
else
    # Current Session Mode
    if [[ $INSIDE_TMUX -eq 0 ]]; then
        echo "Error: PROJECT_DIR arguments specified but not running inside a tmux session." >&2
        exit 1
    fi
fi

# Check for missing directories
MISSING=()
for DIR in "${PROJECT_DIRS[@]}"; do
    if [[ ! -d "$DIR" ]]; then
        MISSING+=("$DIR")
    fi
done

if [[ ${#MISSING[@]} -gt 0 ]]; then
    echo "Error: The following project directories do not exist:" >&2
    for DIR in "${MISSING[@]}"; do
        echo "  $DIR" >&2
    done
    exit 1
fi

NEW_WINDOWS=()

if [[ ${#PROJECT_DIRS[@]} -eq 0 ]]; then
    echo "Error: No project directories specified or found." >&2
    exit 1
fi

if [[ $INSIDE_TMUX -eq 1 ]]; then
    # Current Session Mode: Add windows to current session
    if [[ -z "$TEST_TDE" ]]; then
        # TODO: Check does this make sense i.e. can we open in non-tde sessions?
        SESSION_NAME="$(tmux display-message -p '#S')"
    fi
    tmux_cmd set-option -t "$SESSION_NAME" -g base-index 1
    tmux_cmd set-window-option -t "$SESSION_NAME" -g pane-base-index 1
    # Get existing window names in the session
    EXISTING_WINDOWS="$(existing_windows "$SESSION_NAME")"
    for DIR in "${PROJECT_DIRS[@]}"; do
        WIN_NAME="$(window_name "$DIR")"
        if grep -Fxq "$WIN_NAME" <<<"$EXISTING_WINDOWS"; then
            echo "Warning: Window '$WIN_NAME' already exists in session '$SESSION_NAME', skipping." >&2
            continue
        fi
        tmux_cmd new-window -c "$DIR" -n "$WIN_NAME"
        WIN_INDEX="$(window_index_by_name "$SESSION_NAME" "$WIN_NAME")"
        
        if [[ $PANES -gt 1 ]]; then
            # Split vertically to create pane 2
            tmux_cmd split-window -h -t "$SESSION_NAME:$WIN_INDEX" -c "$DIR"
            
            # Create additional panes 3..PANES in the right side by splitting horizontally
            for ((p=3; p<=$PANES; p++)); do
                tmux_cmd split-window -t "$SESSION_NAME:$WIN_INDEX.2" -c "$DIR"
            done
            tmux_cmd select-layout -E -t "$SESSION_NAME:$WIN_INDEX.2"
        fi
        
        execute_launch_commands "$SESSION_NAME" "$WIN_INDEX" "$DIR"
        tmux_cmd select-pane -t "$SESSION_NAME:$WIN_INDEX.1"
        NEW_WINDOWS+=("$WIN_INDEX")
        # Update EXISTING_WINDOWS so subsequent checks are accurate
        EXISTING_WINDOWS+=$'\n'"$WIN_NAME"
    done
    if [[ ${#NEW_WINDOWS[@]} -gt 0 ]]; then
        tmux_cmd select-window -t "$SESSION_NAME:${NEW_WINDOWS[0]}"
    fi
else
    # New Session Mode: Create new session and add windows
    FIRST_DIR="${PROJECT_DIRS[0]}"
    FIRST_WIN_NAME="$(window_name "$FIRST_DIR")"
    tmux_cmd new-session -d -s "$SESSION_NAME" -c "$FIRST_DIR" -n "$FIRST_WIN_NAME"
    tmux_cmd set-option -t "$SESSION_NAME" -g base-index 1
    tmux_cmd set-window-option -t "$SESSION_NAME" -g pane-base-index 1
    FIRST_WIN_INDEX="$(window_index_by_name "$SESSION_NAME" "$FIRST_WIN_NAME")"
    
    if [[ $PANES -gt 1 ]]; then
        # Split vertically to create pane 2
        tmux_cmd split-window -h -t "$SESSION_NAME:$FIRST_WIN_INDEX" -c "$FIRST_DIR"
        
        # Create additional panes 3..PANES in the right side by splitting horizontally
        for ((p=3; p<=$PANES; p++)); do
            tmux_cmd split-window -t "$SESSION_NAME:$FIRST_WIN_INDEX.2" -c "$FIRST_DIR"
        done
        tmux_cmd select-layout -E -t "$SESSION_NAME:$FIRST_WIN_INDEX.2"
    fi
    
    execute_launch_commands "$SESSION_NAME" "$FIRST_WIN_INDEX" "$FIRST_DIR"
    tmux_cmd select-pane -t "$SESSION_NAME:$FIRST_WIN_INDEX.1"
    NEW_WINDOWS+=("$FIRST_WIN_INDEX")
    # Get existing window names in the session (now includes the first window)
    EXISTING_WINDOWS="$(existing_windows "$SESSION_NAME")"
    for DIR in "${PROJECT_DIRS[@]:1}"; do
        WIN_NAME="$(window_name "$DIR")"
        if grep -Fxq "$WIN_NAME" <<<"$EXISTING_WINDOWS"; then
            echo "Warning: Window '$WIN_NAME' already exists in session '$SESSION_NAME', skipping." >&2
            continue
        fi
        tmux_cmd new-window -t "$SESSION_NAME:" -c "$DIR" -n "$WIN_NAME"
        WIN_INDEX="$(window_index_by_name "$SESSION_NAME" "$WIN_NAME")"
        
        if [[ $PANES -gt 1 ]]; then
            # Split vertically to create pane 2
            tmux_cmd split-window -h -t "$SESSION_NAME:$WIN_INDEX" -c "$DIR"
            
            # Create additional panes 3..PANES in the right side by splitting horizontally
            for ((p=3; p<=$PANES; p++)); do
                tmux_cmd split-window -t "$SESSION_NAME:$WIN_INDEX.2" -c "$DIR"
            done
            tmux_cmd select-layout -E -t "$SESSION_NAME:$WIN_INDEX.2"
        fi
        
        execute_launch_commands "$SESSION_NAME" "$WIN_INDEX" "$DIR"
        tmux_cmd select-pane -t "$SESSION_NAME:$WIN_INDEX.1"
        NEW_WINDOWS+=("$WIN_INDEX")
        EXISTING_WINDOWS+=$'\n'"$WIN_NAME"
    done
    if [[ ${#NEW_WINDOWS[@]} -gt 0 ]]; then
        tmux_cmd select-window -t "$SESSION_NAME:${NEW_WINDOWS[0]}"
    fi
    tmux_cmd attach-session -t "$SESSION_NAME"
fi
